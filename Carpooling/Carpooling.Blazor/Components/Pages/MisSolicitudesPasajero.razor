@page "/solicitudes"
@rendermode InteractiveServer

@using DTOs
@using API.Clients
@using Domain.Model
@using API.Auth.Blazor
@inject ServicioSesionUsuario SesionUsuario
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Mis Solicitudes</PageTitle>

<h3>Mis Solicitudes de Viajes</h3>

@* Mensaje de error general *@
@if (!string.IsNullOrEmpty(errorMensaje))
{
    <div class="alert alert-danger" role="alert">
        @errorMensaje
    </div>
}

@if (puedeAcceder) 
{
    @if (solicitudes == null) 
    {
        <p><em>Cargando solicitudes...</em></p>
    }
    else if (solicitudes.Count == 0) 
    {
        <p>No tienes solicitudes.</p>
        
    }
    else 
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Estado</th>
                    <th>Solicitada</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Estado Viaje</th>
                    <th>Conductor</th>
                    <th>Fecha de Viaje</th>
                    <th>Patente Vehiculo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var sol in solicitudes) 
                {
                    {viaje = viajes.Where(v => v.IdViaje == sol.IdViaje).First();}
                    <tr>
                        <td>@sol.Estado</td>
                        <td>@sol.SolicitudFecha.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@viaje.NombreOrigen</td> 
                        <td>@viaje.NombreDestino</td> 
                        <td>@viaje.Estado</td>
                        <td>@sol.NombreConductor @sol.ApellidoConductor</td>
                        <td>@viaje.FechaHora.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@viaje.Patente</td>
                        <td>
                            @if (sol.Estado == EstadoSolicitud.Pendiente)
                            {
                                <button class="btn btn-danger btn-sm me-1" @onclick="() => CancelarSolicitud(sol.IdSolicitud)" disabled="@procesandoAccion">Cancelar Solicitud</button>
                            }
                            else if (sol.Estado == EstadoSolicitud.Aprobada && viaje.Estado == EstadoViaje.Realizado)
                            {
                                <button class="btn btn-success btn-sm me-1" @onclick="() => IrCalificarConductor(sol.IdViaje)" disabled="@procesandoAccion">Calificar Conductor</button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}
else // Si el usuario no tiene permisos
{
    <p><em>Verificando permisos...</em></p>
    @if (!puedeAcceder && SesionUsuario.EstaLogueado)
    {
        <div class="alert alert-warning mt-3">No tienes permiso para acceder a esta sección.</div>
        
    }
}

@code {
    private List<SolicitudViajeDTO>? solicitudes;
    private List<ViajeDTO> viajes;
    private ViajeDTO viaje;
    private bool puedeAcceder = false; 
    private bool procesandoAccion = false; 
    private string? errorMensaje;

    string? token; 

    protected override async Task OnInitializedAsync()
    {

        if (SesionUsuario.EstaLogueado &&
            (SesionUsuario.UsuarioActual?.TipoUsuario == Domain.Model.TipoUsuario.PasajeroConductor ||
             SesionUsuario.UsuarioActual?.TipoUsuario == Domain.Model.TipoUsuario.Pasajero)) //
        {
            puedeAcceder = true;
            await CargarSolicitudes(); 
            await CargarViajes();
        }
        else if (SesionUsuario.EstaLogueado)
        {
            puedeAcceder = false;
        }
        else
        {
            // No está logueado
            Navigation.NavigateTo("/login"); // Redirige a login
        }
    }

    private async Task CargarSolicitudes()
    {
        var isAuthenticated = await SesionUsuario.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            await SesionUsuario.CheckTokenExpirationAsync();
            token = await SesionUsuario.GetTokenAsync();
            var res = await SolicitudViajeApiClient.GetSolicitudesPorPasajeroAsync(SesionUsuario.UsuarioActual.IdUsuario, token);
            solicitudes = res.ToList();
        }
        else { Navigation.NavigateTo("/login"); }
    }
    private async Task CargarViajes()
    {

        if (!puedeAcceder || token == null) return; // Si no tiene acceso o token, no hace nada

        try
        {
            await SesionUsuario.CheckTokenExpirationAsync(); 
            token = await SesionUsuario.GetTokenAsync(); 
            if (token == null)
            {
                throw new InvalidOperationException("La sesión ha expirado. Por favor, inicie sesión de nuevo.");
            }


            viajes = new List<ViajeDTO>();
            foreach(var sol in solicitudes)
            {
                ViajeDTO v = await ViajeApiClient.GetAsync(sol.IdViaje.ToString());
                viajes.Add(v);
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar viajes: {ex.Message}");
            errorMensaje = $"No se pudieron cargar los viajes: {ex.Message}"; 
            viajes = new List<ViajeDTO>(); 
        }
        InvokeAsync(StateHasChanged); 
    }

    // Método asíncrono para cancelar un viaje
    private async Task CancelarSolicitud(int idSoli)
    {

        if (procesandoAccion) return; 
        procesandoAccion = true; 
        errorMensaje = null; 
        await Task.Delay(1); 

        try
        {
            await SesionUsuario.CheckTokenExpirationAsync(); 
            token = await SesionUsuario.GetTokenAsync(); 
            if (token == null) throw new InvalidOperationException("Sesión expirada.");

            bool confirmado = await JSRuntime.InvokeAsync<bool>("confirm", "¿Está seguro de que desea cancelar este viaje?");
            if (!confirmado) return;

            await SolicitudViajeApiClient.CancelarSolicitudPasajeroAsync(idSoli, token); 
            await CargarViajes();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cancelar la solicitud {idSoli}: {ex.Message}");
            errorMensaje = $"Error al cancelar viaje: {ex.Message}"; 
        }
        finally
        {
            procesandoAccion = false; 
            await CargarSolicitudes();
            await InvokeAsync(StateHasChanged); 
        }
    }


    private void IrCalificarConductor(int idViaje)
    {
        Navigation.NavigateTo($"/calificar-conductor/{idViaje}");
        
    }
}