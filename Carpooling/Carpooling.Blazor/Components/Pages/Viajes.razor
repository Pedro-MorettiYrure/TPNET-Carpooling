@page "/viajes" 
@rendermode InteractiveServer 

@using DTOs 
@using API.Clients 
@using Domain.Model 
@using API.Auth.Blazor 
@inject ServicioSesionUsuario SesionUsuario 
@inject NavigationManager Navigation 
@inject IJSRuntime JSRuntime 

<PageTitle>Mis Viajes</PageTitle>

<h3>Mis Viajes Publicados</h3>

@if (!string.IsNullOrEmpty(errorMensaje))
{
    <div class="alert alert-danger" role="alert">
        @errorMensaje
    </div>
}

@if (puedeAcceder) 
{
    <div class="mb-3">
        <button class="btn btn-success" @onclick="AgregarViaje">
            <span class="bi bi-plus-circle-fill" aria-hidden="true"></span> Publicar Nuevo Viaje
        </button>
    </div>

    @if (viajes == null) 
    {
        <p><em>Cargando viajes...</em></p>
    }
    else if (viajes.Count == 0) 
    {
        <p>Aún no has publicado ningún viaje.</p>
        //
    }
    else 
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Fecha y Hora</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Lugares Disp.</th>
                    <th>Precio</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var viaje in viajes) 
                {
                    <tr>
                        <td>@viaje.FechaHora.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@viaje.NombreOrigen</td>
                        <td>@viaje.NombreDestino</td> 
                        <td>@viaje.CantLugares</td>
                        <td>@viaje.Precio.ToString("C")</td> 
                        <td>@viaje.Estado</td>
                        <td>
                            @switch (viaje.Estado)
                            {
                                case EstadoViaje.Pendiente: // Si el viaje está pendiente
                                                            <button class="btn btn-success btn-sm me-1" @onclick="() => IniciarViaje(viaje.IdViaje)" disabled="@procesandoAccion">Iniciar</button>
                                                            <button class="btn btn-primary btn-sm me-1" @onclick="() => EditarViaje(viaje.IdViaje)" disabled="@procesandoAccion">Editar</button>
                                                            <button class="btn btn-danger btn-sm" @onclick="() => CancelarViaje(viaje.IdViaje)" disabled="@procesandoAccion">Cancelar</button>
                                    break;
                                case EstadoViaje.EnCurso: // Si el viaje está en curso
                                                          <button class="btn btn-warning btn-sm" @onclick="() => FinalizarViaje(viaje.IdViaje)" disabled="@procesandoAccion">Finalizar</button>
                                    break;
                                case EstadoViaje.Realizado: // Si el viaje ya se realizó
                                                            <button class="btn btn-info btn-sm" @onclick="() => IrACalificarPasajeros(viaje.IdViaje)">Calificar Pasajeros</button>
                                    break;
                                case EstadoViaje.Cancelado: // Si el viaje fue cancelado
                                                            <span class="text-muted">Cancelado</span>
                                    break;
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}
else 
{
    <p><em>Verificando permisos...</em></p>
    @if (!puedeAcceder && SesionUsuario.EstaLogueado) 
    {
        <div class="alert alert-warning mt-3">No tienes permiso para acceder a esta sección. Debes ser conductor.</div>
        //
    }
}

@code {
    private List<ViajeDTO>? viajes;
    private bool puedeAcceder = false;
    private bool procesandoAccion = false;
    private string? errorMensaje;

    string? token; 

    protected override async Task OnInitializedAsync()
    {
        await SesionUsuario.IsAuthenticatedAsync(); 
        if (SesionUsuario.EstaLogueado &&
            (SesionUsuario.UsuarioActual?.TipoUsuario == Domain.Model.TipoUsuario.PasajeroConductor ||
             SesionUsuario.UsuarioActual?.TipoUsuario == Domain.Model.TipoUsuario.Administrador)) 
        {
            puedeAcceder = true;
            token = await SesionUsuario.GetTokenAsync(); 
            await CargarViajes(); 
        }
        else if (SesionUsuario.EstaLogueado)
        {
            puedeAcceder = false;
        }
        else
        {
            Navigation.NavigateTo("/login"); 
        }
    }

    // Método asíncrono para cargar los viajes desde la API
    private async Task CargarViajes()
    {
        errorMensaje = null; 
        if (!puedeAcceder || token == null) return; 

        try
        {
            await SesionUsuario.CheckTokenExpirationAsync(); 
            token = await SesionUsuario.GetTokenAsync(); 
            if (token == null)
            {
                throw new InvalidOperationException("La sesión ha expirado. Por favor, inicie sesión de nuevo.");
            }

            var idUsuario = SesionUsuario.UsuarioActual!.IdUsuario; 
            var viajesList = await ViajeApiClient.GetByConductorAsync(idUsuario, token);
            viajes = viajesList.OrderByDescending(v => v.FechaHora).ToList(); 
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar viajes: {ex.Message}");
            errorMensaje = $"No se pudieron cargar los viajes: {ex.Message}"; 
            viajes = new List<ViajeDTO>(); 
        }
        StateHasChanged(); 
    }

    // Navega a la página para agregar un nuevo viaje
    private void AgregarViaje()
    {
        Navigation.NavigateTo("/viaje/nuevo"); 
    }

    // Navega a la página para editar un viaje existente
    private void EditarViaje(int idViaje)
    {
        Navigation.NavigateTo($"/viaje/editar/{idViaje}"); 
    }

    // Método asíncrono para cancelar un viaje
    private async Task CancelarViaje(int idViaje)
    {
        if (procesandoAccion) return; 
        procesandoAccion = true; 
        errorMensaje = null; 
        await Task.Delay(1); 

        try
        {
            await SesionUsuario.CheckTokenExpirationAsync(); 
            token = await SesionUsuario.GetTokenAsync(); 
            if (token == null) throw new InvalidOperationException("Sesión expirada.");

            bool confirmado = await JSRuntime.InvokeAsync<bool>("confirm", "¿Está seguro de que desea cancelar este viaje?");
            if (!confirmado) return; 

            await ViajeApiClient.DeleteAsync(idViaje, token); 
            await CargarViajes(); 
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cancelar el viaje {idViaje}: {ex.Message}");
            errorMensaje = $"Error al cancelar viaje: {ex.Message}"; 
        }
        finally
        {
            procesandoAccion = false; 
            StateHasChanged(); 
        }
    }

    // Método asíncrono para iniciar un viaje
    private async Task IniciarViaje(int idViaje)
    {
        if (procesandoAccion) return;
        procesandoAccion = true;
        errorMensaje = null;
        await Task.Delay(1);

        try
        {
            await SesionUsuario.CheckTokenExpirationAsync(); //
            token = await SesionUsuario.GetTokenAsync(); //
            if (token == null) throw new InvalidOperationException("Sesión expirada.");

            await ViajeApiClient.IniciarViajeAsync(idViaje, token); //
            await CargarViajes();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al iniciar el viaje {idViaje}: {ex.Message}");
            errorMensaje = $"Error al iniciar viaje: {ex.Message}";
        }
        finally
        {
            procesandoAccion = false;
            StateHasChanged();
        }
    }

    // Método asíncrono para finalizar un viaje
    private async Task FinalizarViaje(int idViaje)
    {
        if (procesandoAccion) return;
        procesandoAccion = true;
        errorMensaje = null;
        await Task.Delay(1);

        try
        {
            await SesionUsuario.CheckTokenExpirationAsync(); //
            token = await SesionUsuario.GetTokenAsync(); //
            if (token == null) throw new InvalidOperationException("Sesión expirada.");

            // Llama a la API para cambiar el estado a Realizado
            var response = await ViajeApiClient.FinalizarViajeAsync(idViaje, token); //

            if (response != null) 
            {
                await CargarViajes(); 
            }
            else
            {
                throw new Exception("La respuesta al finalizar el viaje fue inesperada.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al finalizar el viaje {idViaje}: {ex.Message}");
            errorMensaje = $"Error al finalizar viaje: {ex.Message}";
        }
        finally
        {
            procesandoAccion = false;
            StateHasChanged();
        }
    }

    // Método para navegar a la página de calificación (a implementar)
    private void IrACalificarPasajeros(int idViaje)
    {
        Navigation.NavigateTo($"/calificar-pasajeros/{idViaje}");
        StateHasChanged();
    }
}