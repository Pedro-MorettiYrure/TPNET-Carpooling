@page "/calificar-pasajeros/{IdViaje:int}"
@rendermode InteractiveServer

@using DTOs
@using API.Clients
@using API.Auth.Blazor
@using Domain.Model
@using System.ComponentModel.DataAnnotations

@inject ServicioSesionUsuario SesionUsuario
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Calificar Pasajeros del Viaje @IdViaje</PageTitle>

<h3>Calificar Pasajeros del Viaje @IdViaje</h3>

@if (viajeInfo != null && pasajerosParaMostrar != null)
{
    <p>Viaje de <strong>@viajeInfo.NombreOrigen</strong> a <strong>@viajeInfo.NombreDestino</strong> el @viajeInfo.FechaHora.ToString("dd/MM/yyyy HH:mm").</p>

    @if (!pasajerosParaMostrar.Any(p => !p.YaCalificado))
    {
        <div class="alert alert-info">No hay pasajeros pendientes de calificar en este viaje.</div>
    }
    else
    {
        @foreach (var vm in pasajerosParaMostrar)
        {
            <div class="card mb-3">
                <div class="card-header @(vm.YaCalificado ? "bg-light text-muted" : "")">
                    Pasajero: <strong>@vm.Pasajero.Nombre @vm.Pasajero.Apellido</strong> (@vm.Pasajero.Email)
                </div>
                <div class="card-body">
                    @if (vm.YaCalificado && vm.CalificacionExistente != null)
                    {
                        <p class="mb-0">
                            Ya calificaste a este pasajero con <strong>@vm.CalificacionExistente.Puntaje estrellas</strong>
                            @if (!string.IsNullOrEmpty(vm.CalificacionExistente.Comentario))
                            {
                                <span> y comentaste: "@vm.CalificacionExistente.Comentario"</span>
                            }
                            el @vm.CalificacionExistente.FechaHora.ToString("dd/MM/yyyy").
                        </p>
                    }
                    else
                    {
                        // El Model es la propiedad 'Calificacion' del ViewModel
                        <EditForm Model="vm.Calificacion" OnValidSubmit="() => EnviarCalificacion(vm)" FormName={`calif-${vm.Pasajero.IdUsuario}`}>
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="mb-3">
                                <label class="form-label">Puntaje (1-5):</label>
                                <InputRadioGroup @bind-Value="vm.Calificacion.Puntaje">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var puntajeActualLoop = i;
                                        <div class="form-check form-check-inline">
                                            <InputRadio class="form-check-input" id={`puntaje-${vm.Pasajero.IdUsuario}-${i}`}
                                                        Value="puntajeActualLoop" />
                                            <label class="form-check-label" for={`puntaje-${vm.Pasajero.IdUsuario}-${i}`}>@i ★</label>
                                        </div>
                                    }
                                </InputRadioGroup>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Comentario (Opcional):</label>
                                <InputTextArea class="form-control" @bind-Value="vm.Calificacion.Comentario" rows="2" />
                            </div>

                            <button type="submit" class="btn btn-primary btn-sm">
                                @if (vm.Calificando)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                }
                                Calificar
                            </button>

                            @if (!string.IsNullOrEmpty(vm.Error))
                            {
                                <div class="text-danger mt-2">@vm.Error</div>
                            }
                        </EditForm>
                    }
                </div>
            </div>
        }
    }
    <button class="btn btn-secondary mt-3" @onclick="VolverAMisViajes">Volver a Mis Viajes</button>
}
else if (errorCarga != null)
{
    <div class="alert alert-danger">@errorCarga</div>
    <button class="btn btn-secondary mt-3" @onclick="VolverAMisViajes">Volver a Mis Viajes</button>
}
else
{
    <p><em>Cargando pasajeros del viaje...</em></p>
}


@code {
    [Parameter]
    public int IdViaje { get; set; }

    private ViajeDTO? viajeInfo;
    private List<PasajeroCalificacionViewModel> pasajerosParaMostrar = new(); 
    private string? errorCarga;
    private string? token;

    public class CalificacionModel
    {
        [Range(1, 5, ErrorMessage = "El puntaje debe ser entre 1 y 5.")]
        public int Puntaje { get; set; } = 5; 

        [MaxLength(500, ErrorMessage = "El comentario no puede exceder los 500 caracteres.")]
        public string? Comentario { get; set; }
    }

    public class PasajeroCalificacionViewModel
    {
        public UsuarioDTO Pasajero { get; set; } = new();
        public CalificacionModel Calificacion { get; set; } = new();
        public bool Calificando { get; set; } = false; 
        public string? Error { get; set; } 
        public bool YaCalificado { get; set; } = false; 
        public CalificacionDTO? CalificacionExistente { get; set; } 
    }

    protected override async Task OnInitializedAsync()
    {
        await SesionUsuario.IsAuthenticatedAsync();
        if (!SesionUsuario.EstaLogueado || SesionUsuario.UsuarioActual == null || SesionUsuario.UsuarioActual.TipoUsuario != Domain.Model.TipoUsuario.PasajeroConductor)
        {
            errorCarga = "Acceso denegado. Debes ser conductor para calificar.";
            return;
        }

        token = await SesionUsuario.GetTokenAsync();
        if (token == null)
        {
            errorCarga = "Error de sesión. Por favor, inicie sesión nuevamente.";
            return;
        }

        try
        {
            viajeInfo = await ViajeApiClient.GetAsync(IdViaje.ToString());
            if (viajeInfo == null) throw new KeyNotFoundException($"Viaje con ID {IdViaje} no encontrado.");
            if (viajeInfo.IdConductor != SesionUsuario.UsuarioActual.IdUsuario) throw new UnauthorizedAccessException("No tienes permiso para calificar pasajeros de este viaje.");
            if (viajeInfo.Estado != EstadoViaje.Realizado) throw new InvalidOperationException("Solo puedes calificar pasajeros de viajes que ya han sido marcados como 'Realizado'.");

            var pasajerosACalificar = (await ViajeApiClient.GetPasajerosConfirmadosAsync(IdViaje, token)).ToList();
            var calificacionesYaHechas = (await CalificacionApiClient.GetCalificacionesDadasAsync(SesionUsuario.UsuarioActual.IdUsuario, token)).ToList();

            pasajerosParaMostrar.Clear();
            foreach (var p in pasajerosACalificar)
            {
                var vm = new PasajeroCalificacionViewModel { Pasajero = p };

                var califExistente = calificacionesYaHechas
                    .FirstOrDefault(c => c.IdViaje == IdViaje && c.IdCalificado == p.IdUsuario);

                if (califExistente != null)
                {
                    vm.YaCalificado = true;
                    vm.CalificacionExistente = califExistente;
                }
                

                pasajerosParaMostrar.Add(vm);
            }

            if (!pasajerosParaMostrar.Any(p => !p.YaCalificado))
            {
            }
        }
        catch (Exception ex)
        {
            errorCarga = $"Error al cargar datos para calificación: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task EnviarCalificacion(PasajeroCalificacionViewModel vm)
    {
        if (token == null) return;

        vm.Calificando = true; 
        vm.Error = null;      
        await Task.Delay(1);

        var model = vm.Calificacion;

        try
        {
            await SesionUsuario.CheckTokenExpirationAsync();
            token = await SesionUsuario.GetTokenAsync();
            if (token == null) throw new InvalidOperationException("Sesión expirada.");

            var inputDto = new CalificacionInputDTO
            {
                Puntaje = model.Puntaje,
                Comentario = model.Comentario
            };

            var calificacionGuardada = await CalificacionApiClient.CalificarPasajeroAsync(
                IdViaje,
                vm.Pasajero.IdUsuario, 
                inputDto,
                token
            );

            vm.YaCalificado = true;
            vm.CalificacionExistente = calificacionGuardada;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al calificar pasajero {vm.Pasajero.IdUsuario}: {ex.Message}");
            vm.Error = $"Error: {ex.Message}"; 
        }
        finally
        {
            vm.Calificando = false; 
            StateHasChanged();
        }
    }

    private void VolverAMisViajes()
    {
        Navigation.NavigateTo("/viajes");
    }
}